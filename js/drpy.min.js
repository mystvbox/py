import ch from"./cheerio.min.js";
import"./uri.min.js";
import"http://gitcode.net/qq_32394351/dr_py/-/raw/master/txt/pluto/drT.js";
import muban from"https://raw.githubusercontent.com/pluto-player/dr/main/js/template.js";
/**
 * drpy
 * @ hiker道长
 * https://gitcode.net/qq_32394351/dr_py/-/blob/master/libs/drpy.js
 * 
 */
const key="drpy_zbk";function init_test(){}let rule={};const MOBILE_UA="Mozilla/5.0 (Linux; Android 11; M2007J3SC Build/RKQ1.200826.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/77.0.3865.120 MQQBrowser/6.2 TBS/045714 Mobile Safari/537.36",PC_UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36",UA="Mozilla/5.0",UC_UA="Mozilla/5.0 (Linux; U; Android 9; zh-CN; MI 9 Build/PKQ1.181121.001) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/57.0.2987.108 UCBrowser/12.5.5.1035 Mobile Safari/537.36",IOS_UA="Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",RULE_CK="cookie",KEY=void 0!==key&&key?key:"drpy_"+(rule.title||rule.host),CATE_EXCLUDE="首页|留言|APP|下载|资讯|新闻|动态",TAB_EXCLUDE="猜你|喜欢|APP|下载|剧情|热播",OCR_RETRY=3,OCR_API="http://cms.nokia.press/parse/ocr";var MY_URL,VODS=[],vod={};function htmlParse(e,t,l){let r="";try{e&&t&&!e.startsWith("http")||(r=e);let a=ch.load(e),i=[];i=-1!=t.indexOf("&&")?t.split("&&"):["body",t];let o=i[0];if(i.length>1){let e=i[1].toLowerCase();r="text"==e?a(o).text():a(o).attr(e)}l&&!r.startsWith("http")&&(r=new Uri(r).joinUrl(l).toString())}catch(e){console.log(e)}return r.trim()}function readFile(e){e=e||"./uri.min.js";var t=os.open(e),l=new ArrayBuffer(1024);os.read(t,l,0,1024);return String.fromCharCode.apply(null,new Uint8Array(l))}var OcrApi={api:OCR_API,classification:function(e){let t="";try{let l=request(this.api,{data:{img:e},headers:{"User-Agent":PC_UA},method:"POST"});l=JSON.parse(l),t=l.url||""}catch(e){}return t}};function verifyCode(e){let t=0,l=getHome(e),r="";for(;t<OCR_RETRY;){try{let e=request(`${l}/index.php/verify/index.html`,{withHeaders:!0,toBase64:!0}),a=JSON.parse(e);r||(r=a["set-cookie"]?a["set-cookie"].split(";")[0]:"");let i=a.body,o=request(`${l}/index.php/ajax/verify_check?type=search&verify=${OcrApi.classification(i)}`,{headers:{Cookie:r,"User-Agent":MOBILE_UA},method:"POST"});if(o=JSON.parse(o),"ok"===o.msg)return r;"ok"!==o.msg&&t+1>=OCR_RETRY&&(r="")}catch(e){t+1>=OCR_RETRY&&(r="")}t+=1}return r}function setItem(e,t){local.set(KEY,e,t)}function getItem(e,t){return local.get(KEY,e)||t}function clearItem(e){local.delete(KEY,e)}function urljoin(e,t){return e=e||"",t=t||"",joinUrl(e,t)}function pD(e,t,l){let r=pdfh(e,t);return urljoin(MY_URL,r)}function getHome(e){if(!e)return"";let t=e.split("//");return e=t[0]+"//"+t[1].split("/")[0]}function buildUrl(e,t){t=t||{},e.indexOf("?")<0&&(e+="?");let l=[],r=Object.keys(t);r.forEach((e=>{l.push(e+"="+t[e])}));let a=l.join("&");return r.length>0&&!e.endsWith("?")&&(e+="&"),e+=a}function require(url){eval(request(url))}function request(e,t){if(void 0!==t&&t&&t!=={}){let l=t.headers||{},r=Object.keys(l).map((e=>e.toLowerCase()));r.includes("user-agent")||(l["User-Agent"]=MOBILE_UA),r.includes("referer")||(l.Referer=getHome(e)),t.headers=l}else t={headers:{"User-Agent":MOBILE_UA,Referer:getHome(e)}};if(void 0!==t.headers.body&&t.headers.body&&"string"==typeof t.headers.body){let e={};t.headers.body.split("&").forEach((t=>{e[t.split("=")[0]]=t.split("=")[1]})),t.data=e,delete t.headers.body}if(!e)return t.withHeaders?"{}":"";t.toBase64&&(t.buffer=2,delete t.toBase64);let l=req(e,t),r=l.content||"";if(t.withHeaders){let e=l.headers;return e.body=r,JSON.stringify(e)}return r}function checkHtml(e,t,l){if(/\?btwaf=/.test(e)){let r=e.match(/btwaf(.*?)"/)[1];e=request(t=t.split("#")[0]+"?btwaf"+r,l)}return e}function getCode(e,t){let l=request(e,t);return l=checkHtml(l,e,t),l}function getHtml(e){let t={};rule.headers&&(t.headers=rule.headers);let l=getItem(RULE_CK,"");return l&&(t.headers&&!Object.keys(t.headers).map((e=>e.toLowerCase())).includes("cookie")?t.headers.Cookie=l:t.headers||(t.headers={Cookie:l})),getCode(e,t)}function homeParse(e){let t=[];if(e.class_name&&e.class_url){let l=e.class_name.split("&"),r=e.class_url.split("&"),a=Math.min(l.length,r.length);for(let e=0;e<a;e++)t.push({type_id:r[e],type_name:l[e]})}if(e.class_parse){let l=e.class_parse.split(";");if(l.length>=4)try{let r=getHtml(e.MY_URL);if(r){let a=pdfa(r,l[0]);a&&a.length>0&&a.forEach((r=>{try{let a=htmlParse(r,l[1]);if(e.cate_exclude&&new RegExp(e.cate_exclude).test(a))return;let i=htmlParse(r,l[2]);if(l[3]){let e=new RegExp(l[3]);i=i.match(e)[1]}t.push({type_id:i,type_name:a})}catch(e){console.log(e.message)}}))}}catch(e){console.log(e.message)}}let l={class:t};return e.filter&&(l.filters=e.filter),JSON.stringify(l)}function homeVodParse(homeVodObj){let d=[];MY_URL=homeVodObj.homeUrl;let p=homeVodObj.推荐;if(!p)return"{}";if("string"==typeof p&&p.trim().startsWith("js:")){const TYPE="home";var input=MY_URL;const HOST=rule.host;eval(p.trim().replace("js:","")),d=VODS}else{if(p=p.split(";"),!homeVodObj.double&&p.length<5)return"{}";if(homeVodObj.double&&p.length<6)return"{}";let e=getHtml(MY_URL);try{if(homeVodObj.double){p[0]=p[0].trim().startsWith("json:")?p[0].replace("json:",""):p[0];let t=pdfa(e,p[0]);for(let e of t){let t=pdfa(e,p[1]);for(let e of t)try{let t=htmlParse(e,p[2]),l=htmlParse(e,p[3]),r=htmlParse(e,p[4]),a=[];for(let t of p[5].split("+")){let l=homeVodObj.detailUrl?htmlParse(e,t):htmlParse(e,t,MY_URL);a.push(l)}let i={vod_name:t,vod_pic:l,vod_remarks:r,vod_id:a.join("$")};d.push(i)}catch(e){}}}else{p[0]=p[0].trim().startsWith("json:")?p[0].replace("json:",""):p[0];let t=pdfa(e,p[0]);for(let e of t)try{let t=htmlParse(e,p[1]),l="";try{l=pD(e,p[2],MY_URL)}catch(e){}let r=htmlParse(e,p[3]),a=[];for(let t of p[4].split("+")){let l=homeVodObj.detailUrl?htmlParse(e,t):htmlParse(e,t,MY_URL);a.push(l)}let i={vod_name:t,vod_pic:l,vod_remarks:r,vod_id:a.join("$")};d.push(i)}catch(e){}}}catch(e){}}return JSON.stringify({list:d})}function categoryParse(cateObj){let p=cateObj.一级,d=[],url=cateObj.url.replaceAll("fyclass",cateObj.tid);if(rule.filter_url){/fyfilter/.test(url)?url=url.replace("fyfilter",rule.filter_url):(url.endsWith("&")||rule.filter_url.startsWith("&")||(url+="&"),url+=rule.filter_url);let e=cateObj.filter?cateObj.extend:{};url=drT.renderText(url,e)}if(/fypage/.test(url))if(url.includes("(")&&url.includes(")")){let url_rep=url.match(/.*?\((.*)\)/)[1],cnt_page=url_rep.replaceAll("fypage",cateObj.pg);eval(`let cnt_pg=${cnt_page}`),url=url.replaceAll(url_rep,cnt_pg).replaceAll("(","").replaceAll(")","")}else url=url.replaceAll("fypage",cateObj.pg);if(1===cateObj.pg&&url.includes("[")&&url.includes("]")&&(url=url.split("[")[1].split("]")[0]),MY_URL=url,"string"==typeof p&&p.trim().startsWith("js:")){const MY_CATE=cateObj.tid,MY_FL=cateObj.extend,TYPE="cate";var input=MY_URL;const MY_PAGE=cateObj.pg;eval(p.trim().replace("js:","")),d=VODS}else{if(p=p.split(";"),p.length<5)return"{}";try{let e=getHtml(MY_URL);if(e){let t=pdfa(e,p[0]);t.forEach((e=>{d.push({vod_id:htmlParse(e,p[4],MY_URL),vod_name:htmlParse(e,p[1]),vod_pic:htmlParse(e,p[2],MY_URL),vod_remarks:htmlParse(e,p[3])})}))}}catch(e){console.log(e.message)}}return d.length<1?"{}":JSON.stringify({page:parseInt(cateObj.pg),pagecount:999,limit:20,total:999,list:d})}function searchParse(searchObj){let d=[];if(!searchObj.searchUrl)return"{}";let p="*"===searchObj.搜索&&rule.一级?rule.一级:searchObj.搜索,url=searchObj.searchUrl.replaceAll("**",searchObj.wd).replaceAll("fypage",searchObj.pg);if(MY_URL=url,"string"!=typeof p||!p.trim().startsWith("js:")){if(p=p.split(";"),p.length<5)return"{}";try{let e=getHtml(MY_URL);if(e){if(/系统安全验证|输入验证码/.test(e)){let t=verifyCode(MY_URL);t&&setItem(RULE_CK,t),e=getHtml(MY_URL)}e.includes(searchObj.wd)||(console.log("搜索结果源码未包含关键字,疑似搜索失败,正为您打印结果源码"),console.log(e));let t=pdfa(e,p[0]);t.forEach((e=>{let t={vod_id:htmlParse(e,p[4],MY_URL),vod_name:htmlParse(e,p[1]),vod_pic:htmlParse(e,p[2],MY_URL),vod_remarks:htmlParse(e,p[3])};p.length>5&&p[5]&&(t.vod_content=htmlParse(e,p[5])),d.push(t)}))}}catch(e){return"{}"}return JSON.stringify({page:parseInt(searchObj.pg),pagecount:10,limit:20,total:100,list:d})}{const TYPE="search",MY_PAGE=searchObj.pg,KEY=searchObj.wd;var input=MY_URL,detailUrl=rule.detailUrl||"";eval(p.trim().replace("js:","")),d=VODS}}function detailParse(detailObj){let vod={vod_id:"id",vod_name:"片名",vod_pic:"",type_name:"剧情",vod_year:"年份",vod_area:"地区",vod_remarks:"更新信息",vod_actor:"主演",vod_director:"导演",vod_content:"简介"},p=detailObj.二级,url=detailObj.url,detailUrl=detailObj.detailUrl,fyclass=detailObj.fyclass,tab_exclude=detailObj.tab_exclude,html=detailObj.html||"";if(MY_URL=url,"*"===p)vod.vod_play_from="道长在线",vod.vod_remarks=detailUrl,vod.vod_actor="没有二级,只有一级链接直接嗅探播放",vod.vod_content=MY_URL,vod.vod_play_url="嗅探播放$"+MY_URL;else if("string"==typeof p&&p.trim().startsWith("js:")){const TYPE="detail";var input=MY_URL;eval(p.trim().replace("js:",""))}else if(p&&"object"==typeof p){if(html||(html=getHtml(MY_URL)),p.title){let e=p.title.split(";");vod.vod_name=pdfh(html,e[0]).replaceAll("\n"," ").trim();let t=e.length>1?pdfh(html,e[1]).replaceAll("\n"," ").trim():"";vod.type_name=t||vod.type_name}if(p.desc)try{let e=p.desc.split(";");vod.vod_remarks=pdfh(html,e[0]).replaceAll("\n"," ").trim(),vod.vod_year=e.length>1?pdfh(html,e[1]).replaceAll("\n"," ").trim():"",vod.vod_area=e.length>2?pdfh(html,e[2]).replaceAll("\n"," ").trim():"",vod.vod_actor=e.length>3?pdfh(html,e[3]).replaceAll("\n"," ").trim():"",vod.vod_director=e.length>4?pdfh(html,e[4]).replaceAll("\n"," ").trim():""}catch(e){}if(p.content)try{let e=p.content.split(";");vod.vod_content=pdfh(html,e[0]).replaceAll("\n"," ").trim()}catch(e){}if(p.img)try{let e=p.img.split(";");vod.vod_pic=pD(html,e[0],MY_URL)}catch(e){}let vod_play_from="$$$",playFrom=[];if(p.重定向&&p.重定向.startsWith("js:")&&(html=eval(p.重定向.replace("js:",""))),p.tabs){let e=p.tabs.split(";")[0],t=pdfa(html,e);for(let e of t){let t=htmlParse(e,"body&&Text");tab_exclude&&new RegExp(tab_exclude).test(t)||playFrom.push(t)}}else playFrom=["道长在线"];vod.vod_play_from=playFrom.join(vod_play_from);let vod_play_url="$$$",vod_tab_list=[];if(p.lists)for(let e=0;e<playFrom.length;e++){let t=playFrom[e],l=p.tabs.split(";").length>1?p.tabs.split(";")[1]:"",r=p.lists.replaceAll("#idv",t).replaceAll("#id",e);l=l.replaceAll("#idv",t).replaceAll("#id",e);let a=[];try{a=pdfa(html,r)}catch(e){}let i=[];a.forEach((e=>{let t=htmlParse(e,"body&&Text")+"$"+htmlParse(e,"a&&href",MY_URL);i.push(t)}));let o=i.join("#");vod_tab_list.push(o)}vod.vod_play_url=vod_tab_list.join(vod_play_url)}return JSON.stringify({list:[vod]})}function playParse(playObj){MY_URL=playObj.url;var input=MY_URL;let common_play={parse:1,url:MY_URL},lazy_play;if(rule.play_parse&&rule.lazy)if(rule.play_parse&&rule.lazy&&"string"==typeof rule.lazy)try{eval(rule.lazy.replace("js:").trim()),lazy_play="object"==typeof input?input:{parse:1,jx:1,url:input}}catch(e){lazy_play=common_play}else lazy_play=common_play;else lazy_play=common_play;return JSON.stringify(lazy_play)}function init(ext){try{if("object"==typeof ext)rule=ext,rule.template&&(rule=Object.assign(muban[rule.template],rule));else if("string"==typeof ext)if(ext.startsWith("http")){let js=request(ext,{method:"GET"});js&&eval(js.replace("var rule","rule"))}else eval(ext.replace("var rule","rule"));let rule_cate_excludes=(rule.cate_exclude||"").split("|").filter((e=>e.trim())),rule_tab_excludes=(rule.tab_exclude||"").split("|").filter((e=>e.trim()));rule_cate_excludes=rule_cate_excludes.concat(CATE_EXCLUDE.split("|").filter((e=>e.trim()))),rule_tab_excludes=rule_tab_excludes.concat(TAB_EXCLUDE.split("|").filter((e=>e.trim()))),rule.cate_exclude=rule_cate_excludes.join("\n"),rule.tab_exclude=rule_tab_excludes.join("\n"),rule.host=rule.host||"",rule.url=rule.url||"",rule.homeUrl=rule.homeUrl||"",rule.searchUrl=rule.searchUrl||""}catch(e){console.log("init_test发生错误:"+e.message)}}function home(e){return homeParse({filter:rule.filter||!1,MY_URL:rule.host,class_name:rule.class_name||"",class_url:rule.class_url||"",class_parse:rule.class_parse||"",cate_exclude:rule.cate_exclude})}function homeVod(e){let t=rule.host&&rule.homeUrl?urljoin(rule.host,rule.homeUrl):rule.homeUrl||rule.host,l=rule.host&&rule.detailUrl?urljoin(rule.host,rule.detailUrl):rule.detailUrl;return homeVodParse({"推荐":rule.推荐,double:rule.double,homeUrl:t,detailUrl:l})}function category(e,t,l,r){return categoryParse({url:urljoin(rule.host,rule.url),"一级":rule.一级,tid:e,pg:parseInt(t),filter:l,extend:r})}function detail(e){let t="";if(e.indexOf("$")>-1){let l=e.split("$");t=l[0],e=l[1]}let l,r=e;return rule.homeUrl=urljoin(rule.host,rule.homeUrl),rule.detailUrl=urljoin(rule.host,rule.detailUrl),l=r.startsWith("http")||r.includes("/")?r.includes("/")?urljoin(rule.homeUrl,r):r:rule.detailUrl.replaceAll("fyid",r).replaceAll("fyclass",t),detailParse({url:l,"二级":rule.二级,detailUrl:r,fyclass:t,tab_exclude:rule.tab_exclude})}function play(e,t,l){return playParse({url:t,flag:e,flags:l})}function search(e,t){return searchParse({searchUrl:urljoin(rule.host,rule.searchUrl),"搜索":rule.搜索,wd:e,pg:1,quick:t})}function DRPY(){return{init:init,home:home,homeVod:homeVod,category:category,detail:detail,play:play,search:search}}export default{init:init,home:home,homeVod:homeVod,category:category,detail:detail,play:play,search:search,DRPY:DRPY};
